<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2e2e2e;
            /* Dark background */
            color: #f4f4f4;
            /* Light text color */
            margin: 0;
            padding: 10px;
        }

        h1 {
            color: #ffffff;
            /* White for headings */
            text-align: center;
            font-size: 18px;
            margin-bottom: 10px;
        }

        h2 {
            color: #ffffff;
            /* Header color */
            text-align: center;
            /* Center align the header */
            margin-bottom: 10px;
            /* Space below the header */
            font-size: 20px;
            /* Adjust font size */
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #3e3e3e;
            /* Darker background for the container */
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 6px;
            margin: 4px 0;
            border: 1px solid #555;
            /* Darker border */
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 12px;
            background-color: #2e2e2e;
            /* Dark background for inputs */
            color: #f4f4f4;
            /* Light text for inputs */
        }

        .header-key,
        .header-value {
            flex: 1;
            /* Allow inputs to grow and take available space */
            margin-right: 8px;
            /* Add space between input fields and delete icon */
        }

        #headerContainer {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            position: relative;
        }

        .plus-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background-color: #007acc;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin-left: 5px;
            align-self: center;
        }

        .plus-icon:before,
        .plus-icon:after {
            content: '';
            position: absolute;
            background-color: white;
        }

        .plus-icon:before {
            width: 2px;
            height: 8px;
            top: 5px;
            left: 8px;
        }

        .plus-icon:after {
            width: 8px;
            height: 2px;
            top: 8px;
            left: 5px;
        }

        .delete-icon {
            display: none;
            /* Initially hidden */
            width: 18px;
            height: 18px;
            background-color: red;
            /* Change color as needed */
            border-radius: 3px;
            position: absolute;
            /* Position it absolutely within the header row */
            right: 5px;
            /* Position it a bit from the right edge */
            top: 50%;
            /* Center vertically */
            transform: translateY(-50%);
            /* Adjust for vertical centering */
            cursor: pointer;
        }

        .header-row:hover .delete-icon {
            display: block;
            /* Show delete icon on hover */
        }

        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 12px;
            margin-top: 5px;
        }

        button:hover {
            background-color: #005999;
        }

        pre {
            background-color: #1e1e1e;
            /* Dark background for preformatted text */
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            /* Darker border */
            overflow: auto;
            white-space: pre-wrap;
            margin-top: 8px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            color: #f4f4f4;
            /* Light text for preformatted text */
        }

        #savedRequestsContainer {
            margin-top: 10px;
        }

        .request-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            margin-bottom: 5px;
            background-color: #3e3e3e;
            transition: background-color 0.3s;
        }

        .request-method,
        .request-url,
        .request-data,
        .request-headers {
            overflow: hidden;
            /* Hide overflow */
            white-space: normal;
            /* Allow text to wrap */
        }

        .request-row:hover {
            background-color: #505050;
            /* Highlight on hover */
        }

        .request-method {
            flex: 1;
            font-weight: bold;
        }

        .request-url {
            flex: 3;
            word-wrap: break-word;
            /* Allow breaking for long URLs */
        }


        .request-data {
            flex: 2;
        }

        .request-headers {
            flex: 3;
            word-wrap: break-word;
            /* Allow breaking for long headers */
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>API Tester</h1>
        <input type="text" id="baseUrl" placeholder="Base URL" />
        <input type="text" id="endpoint" placeholder="Endpoint" />
        <select id="method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
        </select>
        <textarea id="data" placeholder="Request Data (JSON)" style="display: none;"></textarea>

        <h2>Headers</h2>
        <div id="headerContainer">
            <div class="header-row">
                <input type="text" class="header-key" placeholder="Header Key" />
                <input type="text" class="header-value" placeholder="Header Value" />
                <span class="delete-icon" title="Delete Header" onclick="deleteHeader(this)">✖</span>
            </div>
            <span id="addHeader" class="plus-icon" title="Add Header"></span>
        </div>

        <button id="send">Send Request</button>
        <button id="save">Save Request</button>
        <pre id="response"></pre>
        <h2>Saved Requests</h2>
        <div id="savedRequestsContainer"></div>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        document.addEventListener('DOMContentLoaded', () => {

            const methodSelect = document.getElementById('method');
            const dataTextarea = document.getElementById('data');
            const responsePre = document.getElementById('response');
            const headerContainer = document.getElementById('headerContainer');

            // Function to toggle the visibility of the Request Data field
            const toggleDataField = () => {
                const method = methodSelect.value;
                if (method === 'POST' || method === 'PUT') {
                    dataTextarea.style.display = 'block'; // Show for POST and PUT
                } else {
                    dataTextarea.style.display = 'none'; // Hide for GET and DELETE
                    dataTextarea.value = ''; // Clear the textarea
                }
            };

            methodSelect.addEventListener('change', toggleDataField);

            // Initialize visibility based on the default selected method
            toggleDataField();

            document.getElementById('addHeader').addEventListener('click', () => {
                const headerRow = document.createElement('div');
                headerRow.className = 'header-row';

                const headerKeyInput = document.createElement('input');
                headerKeyInput.className = 'header-key';
                headerKeyInput.placeholder = 'Header Key';

                const headerValueInput = document.createElement('input');
                headerValueInput.className = 'header-value';
                headerValueInput.placeholder = 'Header Value';

                const deleteIcon = document.createElement('span');
                deleteIcon.className = 'delete-icon';
                deleteIcon.title = 'Delete Header';
                deleteIcon.innerText = '✖';
                deleteIcon.onclick = function () {
                    deleteHeader(deleteIcon);
                };

                headerRow.appendChild(headerKeyInput);
                headerRow.appendChild(headerValueInput);
                headerRow.appendChild(deleteIcon);
                headerContainer.insertBefore(headerRow, addHeader); // Insert new header row before the plus icon
            });

            document.getElementById('send').addEventListener('click', () => {
                console.log('Send button clicked');
                const baseUrl = document.getElementById('baseUrl').value;
                const endpoint = document.getElementById('endpoint').value;
                const method = document.getElementById('method').value;
                const data = document.getElementById('data').value;

                // Collect headers
                const headers = {};
                const headerKeys = document.querySelectorAll('.header-key');
                const headerValues = document.querySelectorAll('.header-value');
                headerKeys.forEach((key, index) => {
                    if (key.value) {
                        headers[key.value] = headerValues[index].value;
                    }
                });

                // Validate JSON for POST and PUT requests
                if ((method === 'POST' || method === 'PUT') && data) {
                    try {
                        JSON.parse(data); // Try to parse the JSON
                    } catch (error) {
                        responsePre.innerText = `Error: Invalid JSON format. ${error.message}`;
                        return; // Stop processing if JSON is invalid
                    }
                }

                vscode.postMessage({
                    command: 'sendRequest',
                    baseUrl,
                    endpoint,
                    method,
                    data: method === 'GET' || method === 'DELETE' ? null : JSON.parse(data),
                    headers
                });
            });
            document.getElementById('save').addEventListener('click', () => {
                const baseUrl = document.getElementById('baseUrl').value;
                const endpoint = document.getElementById('endpoint').value;
                const method = document.getElementById('method').value;
                const data = document.getElementById('data').value;

                // Collect headers
                const headers = {};
                const headerKeys = document.querySelectorAll('.header-key');
                const headerValues = document.querySelectorAll('.header-value');
                headerKeys.forEach((key, index) => {
                    if (key.value) {
                        headers[key.value] = headerValues[index].value;
                    }
                });

                vscode.postMessage({
                    command: 'saveRequest',
                    baseUrl,
                    endpoint,
                    method,
                    data: method === 'GET' || method === 'DELETE' ? null : data,
                    headers
                });
            });
        });
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'showResponse':
                    document.getElementById('response').innerText = JSON.stringify(message.response, null, 2);
                    break;
                case 'showError':
                    document.getElementById('response').innerText = `Error: ${message.error} `;
                    break;
                case 'loadRequests':
                    const requestsContainer = document.getElementById('savedRequestsContainer');
                    requestsContainer.innerHTML = '';
                    message.requests.forEach(request => {
                        const requestDiv = document.createElement('div');
                        requestDiv.className = 'request-row';
                        requestDiv.innerHTML = `<span class="request-method">${request.method}</span>
                                                <span class="request-url">${request.baseUrl}${request.endpoint}</span>
                                                <span class="request-data">${request.data || ''}</span>
                                                <span class="request-headers">${JSON.stringify(request.headers)}</span>
                                                `;
                        requestsContainer.appendChild(requestDiv);
                    });

                    break;
            }
        });
        function deleteHeader(deleteIcon) {
            const headerRow = deleteIcon.parentElement;
            const headerKeyInput = headerRow.querySelector('.header-key');
            const headerValueInput = headerRow.querySelector('.header-value');
            const headerContainer = document.getElementById('headerContainer');

            // Clear the input fields
            headerKeyInput.value = '';
            headerValueInput.value = '';

            // Prevent deletion if it's the last header row
            if (headerContainer.childElementCount <= 2) { // 1 for addHeader, 1 for the current row
                alert('Cannot delete the last header row.');
                return;
            }

            headerContainer.removeChild(headerRow);
        }
    </script>
</body>

</html>